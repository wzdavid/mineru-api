# MinerU Service Configuration

# Redis Configuration
# Note: When using Docker Compose, configure REDIS_URL in docker/.env instead
# This REDIS_URL is only used when running the application directly (not in Docker)
# Options:
#   1. Local Redis: redis://localhost:6379/0
#   2. Remote Redis: redis://192.168.1.100:6379/0
#   3. Redis with password: redis://:password@localhost:6379/0
#   4. Redis with authentication: redis://username:password@localhost:6379/0
REDIS_URL=redis://localhost:6379/0

# API Server Configuration
API_HOST=0.0.0.0
API_PORT=8000

# Storage Configuration
# Storage type: local (local filesystem, shared via Docker volume) or s3 (S3-compatible storage, supports distributed deployment)
MINERU_STORAGE_TYPE=local

# Paths (only used when MINERU_STORAGE_TYPE=local)
TEMP_DIR=/tmp/mineru_temp
OUTPUT_DIR=/tmp/mineru_output

# S3 Storage Configuration (only used when MINERU_STORAGE_TYPE=s3)
# S3-compatible storage configuration (supports MinIO, AWS S3, etc.)
MINERU_S3_ENDPOINT=http://minio:9000
MINERU_S3_ACCESS_KEY=minioadmin
MINERU_S3_SECRET_KEY=minioadmin
MINERU_S3_BUCKET_TEMP=mineru-temp
MINERU_S3_BUCKET_OUTPUT=mineru-output
MINERU_S3_SECURE=false
MINERU_S3_REGION=

# Celery Task Execution
TASK_TIME_LIMIT=7200
TASK_SOFT_TIME_LIMIT=6000
TASK_MAX_RETRIES=0
TASK_RETRY_DELAY=300
RESULT_EXPIRES=86400

# Celery Queue Routing
MINERU_QUEUE=mineru-tasks
MINERU_EXCHANGE=mineru
MINERU_ROUTING_KEY=mineru.tasks

# Worker Configuration
WORKER_NAME=mineru-worker
WORKER_CONCURRENCY=2
# MinerU must use threads pool: MinerU internally uses ProcessPoolExecutor, daemon child processes of prefork pool cannot create child processes
# threads: supports MinerU's internal multi-process handling, but does not support revoke(task_id, terminate=True)
WORKER_POOL=threads
WORKER_MAX_TASKS_PER_CHILD=100
WORKER_PREFETCH_MULTIPLIER=1
WORKER_MAX_MEMORY_PER_CHILD=2000000 # 2GB

# MinerU Device Options: cuda, mps, npu, cpu, auto (auto detect)
MINERU_DEVICE_MODE=auto

# MinerU Parsing Options
MINERU_FORMULA_ENABLE=true
MINERU_TABLE_ENABLE=true
MINERU_PARSE_METHOD=auto
MINERU_LANG=ch
MINERU_EMBED_IMAGES_IN_MD=true
MINERU_RETURN_IMAGES_BASE64=true

# MinerU Pagination Options (for large PDFs)
# Enable automatic pagination for large PDFs
MINERU_ENABLE_PAGINATION=true
# Page count threshold to trigger pagination (default: 100 pages)
MINERU_PAGINATION_THRESHOLD=100
# Number of pages per chunk when pagination is enabled (default: 50 pages)
MINERU_PAGE_CHUNK_SIZE=50
# Maximum number of parallel chunk tasks (default: 5)
MINERU_MAX_PARALLEL_CHUNKS=5

# MinerU Model Configuration
# Model source: modelscope, huggingface, local (used by MinerU library, set in Dockerfile for model download)
# Note: This is used by MinerU library itself, not directly by our code
MINERU_MODEL_SOURCE=modelscope

# The type of the model to download: pipeline, vlm, all
MINERU_MODEL_TYPE=pipeline

# Uncoment this to use the CPU as a fallback for MPS, as the operator 'torchvision::nms' is not currently implemented for the MPS device
# PYTORCH_ENABLE_MPS_FALLBACK=1

# MinIO Configuration (Optional, for image uploads only)
# Note: This configuration is only for image upload functionality, independent of storage configuration (MINERU_STORAGE_TYPE)
MINIO_ENDPOINT=
MINIO_ACCESS_KEY=
MINIO_SECRET_KEY=
MINIO_BUCKET=
MINIO_SECURE=false

# Cleanup Scheduler Configuration
# mineru-cleanup service starts automatically (no profile, required service)
CLEANUP_INTERVAL_HOURS=24
CLEANUP_EXTRA_HOURS=2

# CORS Configuration
# Comma-separated list of allowed origins (leave empty to allow all in development)
# For production, explicitly set allowed origins
# 
# ===== 重要说明 =====
# CORS 只在前端浏览器直接调用 API 时才需要配置
# 如果 mineru-api 只被后端服务调用（服务器到服务器），则不需要配置 CORS
# 
# ===== 前端应用集成配置 =====
# 如果 mineru-api 被前端应用通过浏览器直接调用（如 JavaScript fetch/axios），需要配置 CORS
# 根据部署场景选择以下配置之一：
#
# 场景 1: 前端应用和 mineru-api 在同一服务器，通过容器网络访问
# 注意：如果前端通过后端代理调用 mineru-api，则不需要 CORS（后端调用不需要 CORS）
# CORS_ALLOWED_ORIGINS=
#
# 场景 2: 前端应用和 mineru-api 在同一服务器，通过宿主机端口访问
# 示例：允许本地开发环境的前端应用访问
# CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8080
# 或使用前端应用的域名/IP
# CORS_ALLOWED_ORIGINS=http://app.example.com,http://192.168.1.100:3000
#
# 场景 3: 前端应用和 mineru-api 在不同服务器
# 使用前端应用的完整 URL（包括协议、域名和端口）
# CORS_ALLOWED_ORIGINS=https://app.example.com,http://app-server-ip:3000
#
# 多个来源用逗号分隔，例如：
# CORS_ALLOWED_ORIGINS=http://localhost:3000,https://app1.example.com,https://app2.example.com
#
# 开发环境（允许所有来源，不推荐用于生产）
# CORS_ALLOWED_ORIGINS=
CORS_ALLOWED_ORIGINS=
ENVIRONMENT=development

# File Upload Limits
# Maximum file size in bytes (default: 100MB)
MAX_FILE_SIZE=104857600

# Note: Docker build configuration (PIP_INDEX_URL, service ports, etc.) 
# should be configured in docker/.env (copy from docker/.env.example)
