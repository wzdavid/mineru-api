# Base MinerU Dockerfile
# This creates the foundation layer with MinerU core installation
# Based on MinerU official vllm image; see MinerU docker/china/Dockerfile for reference.
#
# vLLM base image version and GPU support (Compute Capability: https://developer.nvidia.com/cuda-gpus):
#
# v0.10.1.1  Ampere, Ada Lovelace, Hopper (8.0 <= CC <= 9.0). x86_64 only.
#            Does NOT support Volta/Turing (CC < 8.0) or Blackwell (RTX 5090, CC >= 10.0).
#
# v0.11.0    Volta, Turing (7.0 < CC < 8.0) and Blackwell (CC >= 10.0).
#            Also supports Ampere/Ada/Hopper (8.0â€“9.0), so it is a superset of v0.10.1.1.
#            x86_64 and ARM (AArch64). Use this for one image that works across all supported GPUs.
#
# Default: v0.11.0 so that RTX 5090 (Blackwell) and older Volta/Turing GPUs work without switching image.

# Official: FROM vllm/vllm-openai:v0.11.0
FROM docker.m.daocloud.io/vllm/vllm-openai:v0.11.0

ARG PIP_INDEX_URL=https://pypi.org/simple

# MinerU default: v0.10.1.1 (Ampere/Ada/Hopper only; fails on RTX 5090 and on Volta/Turing)
# FROM vllm/vllm-openai:v0.10.1.1
# FROM docker.m.daocloud.io/vllm/vllm-openai:v0.10.1.1

# Turing / Volta (7.0 < CC < 8.0) or other edge cases: v0.10.2 was sometimes used; v0.11.0 covers these too.
# FROM vllm/vllm-openai:v0.10.2
# FROM docker.m.daocloud.io/vllm/vllm-openai:v0.10.2

# Configure Aliyun mirror for Debian (optional, for faster package downloads in China)
# Note: vllm base image may use Ubuntu, this configuration may not apply
# If the base image uses Debian, uncomment the following line:
# RUN echo "Types: deb\nURIs: http://mirrors.aliyun.com/debian/\nSuites: bookworm bookworm-updates\nComponents: main\n\nTypes: deb\nURIs: http://mirrors.aliyun.com/debian-security/\nSuites: bookworm-security\nComponents: main" > /etc/apt/sources.list.d/debian.sources || true

# Install libgl for opencv support & Noto fonts for Chinese characters
RUN apt-get update && \
    apt-get install -y \
        fonts-noto-core \
        fonts-noto-cjk \
        fontconfig \
        libgl1 && \
    fc-cache -fv && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install mineru latest
RUN python3 -m pip install -U 'mineru[core]' -i ${PIP_INDEX_URL} --break-system-packages && \
    python3 -m pip cache purge

# Download models and update the configuration file
RUN /bin/bash -c "mineru-models-download -s modelscope -m all"

# Set the entry point to activate the virtual environment and run the command line tool
# Set entry point to activate virtual environment and run command line tools
ENTRYPOINT ["/bin/bash", "-c", "export MINERU_MODEL_SOURCE=local && exec \"$@\"", "--"]

# Build command for this base image:
# docker build -f docker/Dockerfile.base -t mineru-vllm:latest .
#
# Or use the build script from docker/ directory:
# cd docker && sh build.sh --worker-gpu
#
# This base image must be built before building mineru-worker-gpu,
# as Dockerfile.worker depends on it: FROM mineru-vllm:latest